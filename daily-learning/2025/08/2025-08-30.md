# SwiftUI Property Wrapper 완벽 가이드

## 📚 학습 날짜: 2025.08.30

## 1. Property Wrapper란?

Property Wrapper는 변수에 "특별한 능력"을 부여하는 Swift의 기능입니다.

```swift
// 일반 변수
private var normalItem: String = ""

// Property Wrapper를 사용한 변수
@State private var item: String = ""  // 값이 변경되면 View를 다시 그림
```

### 핵심 특징
- `@` 기호로 시작
- 변수의 저장과 접근 방식을 커스터마이징
- SwiftUI에서 View와 데이터를 연결하는 핵심 메커니즘

## 2. SwiftUI View의 동작 원리

### View는 불변(Immutable) 구조체

```swift
struct TestView: View {
    // ❌ 컴파일 에러: struct 내부에서 직접 값 변경 불가
    private var counter: Int = 0

    var body: some View {
        Button("증가") {
            counter += 1  // Error: Cannot assign to property
        }
    }
}
```

### SwiftUI의 렌더링 사이클

```
1. @State 값 변경
   ↓
2. SwiftUI가 변경 감지
   ↓
3. body 다시 호출
   ↓
4. 이전 View와 새 View 비교
   ↓
5. 변경된 부분만 화면 업데이트
```

### View와 State Storage의 분리

```
View Struct (임시, 가벼움)
    ↓ 참조
State Storage (영구적, SwiftUI가 관리)
    - 실제 데이터가 저장되는 곳
    - View가 재생성되어도 값 유지
```

## 3. 주요 Property Wrapper 상세 분석

### @State

**목적**: View가 소유하고 관리하는 로컬 상태

```swift
@State private var text: String = "Hello"
@State private var count: Int = 0
```

**특징**:
- 초기값 필수
- View 내부에서만 사용
- 값 변경 시 자동으로 View 업데이트
- `$` 프리픽스로 양방향 바인딩 제공

**내부 동작**:
```swift
// @State는 실제로 3가지 접근 방법 제공
@State private var counter = 0

// 1. counter → 실제 값 (Int)
// 2. _counter → State<Int> wrapper 인스턴스
// 3. $counter → Binding<Int> 양방향 바인딩
```

### @Environment

**목적**: 시스템이나 부모 View가 제공하는 환경 값 접근

```swift
@Environment(\.modelContext) private var modelContext
@Environment(\.dismiss) private var dismiss
@Environment(\.colorScheme) private var colorScheme
```

**특징**:
- KeyPath를 통해 원하는 값 지정
- 초기값 설정 불가 (시스템이 제공)
- 괄호 안에 KeyPath 전달

**KeyPath 문법**:
```swift
// \.modelContext는 KeyPath<EnvironmentValues, ModelContext>를 의미
// 백슬래시(\)와 점(.)으로 시작하는 특별한 문법
```

### @Query

**목적**: SwiftData에서 자동으로 데이터 가져오기

```swift
@Query private var items: [Item]
@Query(sort: \.timestamp) private var sortedItems: [Item]
```

**특징**:
- 초기값 불필요 (데이터베이스가 자동 제공)
- 데이터 변경 시 자동 업데이트
- 정렬, 필터 등 옵션 가능

### @FocusState

**목적**: 텍스트 필드의 포커스 상태 관리

```swift
// Bool 방식 (단일 필드)
@FocusState private var isFocused: Bool

// Enum 방식 (다중 필드)
enum Field {
    case username
    case password
}
@FocusState private var focusedField: Field?
```

**특징**:
- Bool 또는 Optional Enum 타입
- 키보드 포커스 제어
- nil = 포커스 해제 (키보드 숨김)

**사용 예제**:
```swift
TextField("Username", text: $username)
    .focused($focusedField, equals: .username)

Button("키보드 숨기기") {
    focusedField = nil  // 포커스 해제
}
```

## 4. Property Wrapper 초기화 패턴

### 패턴 1: 초기값 직접 할당
```swift
@State private var text: String = "Hello"
// 컴파일러가 자동으로 init(wrappedValue:) 호출
```

### 패턴 2: 파라미터 전달
```swift
@Environment(\.modelContext) private var context
// init(_ keyPath:) 호출
```

### 패턴 3: 복합 초기화
```swift
// 커스텀 Property Wrapper 예제
@propertyWrapper
struct Limited {
    init(wrappedValue: String = "", _ maxLength: Int) {
        // wrappedValue와 추가 파라미터 모두 받음
    }
}

@Limited(10) var text: String = "Hello"  // 초기값과 제한 길이
```

## 5. 실전 예제 분석

### 제공된 Grocery List 앱 코드

```swift
struct ContentView: View {
    // 시스템 환경에서 ModelContext 가져오기
    @Environment(\.modelContext) private var modelContext

    // 데이터베이스에서 Item 목록 자동 조회
    @Query private var items: [Item]

    // 사용자 입력을 위한 로컬 상태
    @State private var item: String = ""

    // TextField 포커스 관리
    @FocusState private var isFocused: Bool

    var body: some View {
        // ...
        TextField("", text: $item)  // $로 양방향 바인딩
            .focused($isFocused)     // 포커스 상태 연결

        Button {
            // 버튼 액션에서 포커스 해제
            isFocused = false
        }
    }
}
```

## 6. 핵심 개념 정리

### View Protocol과 some View

```swift
struct MyView: View {  // View 프로토콜 채택
    var body: some View {  // 계산 프로퍼티
        Text("Hello")      // 실제 반환 타입은 Text
    }
}
```

- `some View`: "어떤 View 타입인데, 컴파일러가 추론"
- 복잡한 View 조합의 타입을 간단하게 표현

### $ 프리픽스의 의미

```swift
@State private var text = ""

// text → String (실제 값)
// $text → Binding<String> (양방향 바인딩)

TextField("", text: $text)  // TextField가 값을 읽고 쓸 수 있음
```

### nil in Optional FocusState

```swift
@FocusState private var field: Field?

// nil의 의미:
// - "우리가 관리하는 필드 중 아무것도 포커스되지 않은 상태"
// - 키보드 숨기기
// - 관리 대상이 아닌 필드가 포커스를 받은 경우
```

## 7. 학습 요약

### Property Wrapper가 해결하는 문제들

1. **상태 관리**: View는 불변이지만 상태는 변경 가능해야 함
2. **데이터 동기화**: 데이터 변경 시 자동 UI 업데이트
3. **환경 공유**: 부모-자식 View 간 데이터 전달
4. **시스템 통합**: 포커스, 데이터베이스 등과 연동

### 각 Property Wrapper의 데이터 출처

| Property Wrapper | 데이터 출처 | 초기값 | 용도 |
|-----------------|------------|--------|------|
| @State | 우리가 생성/관리 | 필수 | 로컬 상태 |
| @Environment | 시스템/부모 View | 불가 | 환경 값 접근 |
| @Query | 데이터베이스 | 불가 | 데이터 자동 조회 |
| @FocusState | 시스템 추적 | 불가 | 포커스 제어 |

## 8. 추가 학습 자료

- [Apple Developer Documentation - Property Wrappers](https://docs.swift.org/swift-book/LanguageGuide/Properties.html#ID617)
- [SwiftUI Property Wrappers](https://developer.apple.com/documentation/swiftui/state-and-data-flow)
- [SwiftData @Query](https://developer.apple.com/documentation/swiftdata/query)

---

*이 문서는 SwiftUI Property Wrapper에 대한 심층 학습 세션의 정리입니다.*
*실제 코드와 실험을 통해 각 개념을 탐구하고 이해했습니다.*
